<!DOCTYPE html>
<html lang="mr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>तालुका योजना रँकिंग डॅशबोर्ड</title>
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;700&display=swap" rel="stylesheet">
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body { font-family:'Noto Sans Devanagari',sans-serif; background:#f8f9fa; }
    .header-gradient { background: linear-gradient(135deg,#667eea,#764ba2);}
    .card { border:none; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1);}
    .card:hover { transform:translateY(-5px);}
    .kpi-icon { width:2rem; height:2rem; vertical-align:middle; margin-right:.6rem; opacity:0.8;}
    .table-row-top3 { border-left:5px solid #28a745; background:rgba(40,167,69,0.1);}
    .table-row-mid5 { border-left:5px solid #ffc107; background:rgba(255,193,7,0.10);}
    .table-row-bottom5 { border-left:5px solid #dc3545; background:rgba(220,53,69,0.06);}
    .highlight-scheme { color:#198754; font-weight:700;}
    .highlight-bad { color:#dc3545; font-weight:700;}
    .table thead th {vertical-align:middle;}
    .chart-container { position:relative;height:300px;}
    .loading-overlay { position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.93);display:none;align-items:center;justify-content:center;z-index:9999;}
    .loading-spinner { width:4rem;height:4rem;border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;animation:spin 1s linear infinite;}
    @keyframes spin { to{transform:rotate(360deg);} }
    .btn-primary, .btn-secondary { min-width:96px;}
    .modal-lg { max-width:90vw; }
    .summary-cell { min-width:52px; }
    .summary-top { background: #e3fbe4; color:#198754; font-weight:bold; }
    .summary-bottom { background: #fde1e4; color:#dc3545; font-weight:bold; }
    .summary-med { background: #fffbe3; }
    .summary-taluka { font-weight:600; background:#f0f0ff;}
  </style>
</head>
<body>
  <div id="loadingOverlay" class="loading-overlay"><div class="loading-spinner"></div></div>
  <header class="header-gradient py-4 mb-4 text-white">
    <div class="container d-flex justify-content-between align-items-center">
      <h1><i class="fas fa-chart-line me-2"></i>तालुका योजना रँकिंग डॅशबोर्ड</h1>
      <button id="refreshBtn" class="btn btn-light btn-lg">
        <i class="fas fa-sync-alt me-2"></i>डेटा रिफ्रेश करा
      </button>
    </div>
  </header>
  <div class="container">
    <!-- KPI Cards -->
    <div class="row mb-4" id="kpiCards"></div>

    <div class="row mb-4 align-items-end">
      <div class="col-md-4">
        <label class="form-label h5">
          <i class="fas fa-filter me-2"></i>योजना निवडा:
        </label>
        <select id="schemeSelect" class="form-select"><option value="all">सर्व योजना</option></select>
      </div>
      <div class="col-md-4">
        <label class="form-label h5">
          <i class="fas fa-map-marker-alt me-2"></i>तालुका निवडा:
        </label>
        <select id="talukaSelect" class="form-select" multiple size="6"></select>
      </div>
      <div class="col-md-4 text-center">
        <button id="submitBtn" class="btn btn-primary me-2">Submit</button>
        <button id="resetBtn" class="btn btn-outline-secondary me-2">Reset</button>
        <button id="summaryBtn" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#summaryModal"><i class="fas fa-list me-2"></i>Summary</button>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="fas fa-table me-2"></i>तालुका रँकिंग टेबल</h5>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table id="rankingTable" class="table table-hover mb-0">
            <thead>
              <tr id="tableHeader">
                <th>तालुका</th>
                <th>टॉप योजनांची संख्या</th>
                <th>योजना (टॉप)</th>
                <th>सुधारणा आवश्यक योजना</th>
                <th>योजना (कमकुवत)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="row mb-5">
      <div class="col-lg-6 mb-4" id="topChartContainer">
        <div class="card">
          <div class="card-header bg-success text-white">
            <h6 class="mb-0"><i class="fas fa-trophy me-2"></i><span id="topChartTitle">Top 3 Talukas</span></h6>
          </div>
          <div class="card-body"><div class="chart-container"><canvas id="topChart"></canvas></div></div>
        </div>
      </div>
      <div class="col-lg-6 mb-4" id="bottomChartContainer">
        <div class="card">
          <div class="card-header bg-danger text-white">
            <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i><span id="bottomChartTitle">Bottom 5 Talukas</span></h6>
          </div>
          <div class="card-body"><div class="chart-container"><canvas id="bottomChart"></canvas></div></div>
        </div>
      </div>
    </div>

    <!-- Summary Modal -->
    <div class="modal fade" id="summaryModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">तक्रारात्मक सारांश (Complete Data View)</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="table-responsive">
              <table id="summaryTable" class="table table-bordered align-middle text-center">
                <thead class="table-light"><tr id="summaryHeader"></tr></thead>
                <tbody id="summaryBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
  <!-- BOOTSTRAP JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // --- CONFIG ---
    const SHEET_ID = '1aINSij-6mXtt4Gbocn0A1PHbuh7XMImHL0zFmdVKhVs';
    const API_KEY  = 'AIzaSyBmci6WRXJCilTloJnQ1F6gc2qg1aJ96o0';
    const RANGE    = 'Rank!B5:AI20';
    const API_URL  = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;

    class Dashboard {
      constructor() {
        this.data={talukas:[],schemes:[],rankings:[],processed:[]};
        this.currentScheme = 'all';
        this.currentTalukas = [];
        this.charts={};
        this.init();
      }
      init() {
        document.getElementById('refreshBtn').onclick    = () => this.load();
        document.getElementById('schemeSelect').onchange = e => this.currentScheme = e.target.value;
        document.getElementById('submitBtn').onclick     = () => this.updateAll();
        document.getElementById('resetBtn').onclick      = () => window.location.reload();
        document.getElementById('summaryBtn').onclick    = () => this.fillSummary();
        this.load();
      }
      showLoading() { document.getElementById('loadingOverlay').style.display='flex'; }
      hideLoading() { document.getElementById('loadingOverlay').style.display='none'; }
      async load() {
        this.showLoading();
        try {
          const resp = await fetch(API_URL);
          const v = (await resp.json()).values;
          this.data.schemes = v[0].slice(1);
          this.data.talukas = v.slice(1).map(r => r[0]);
          this.data.rankings = v.slice(1).map(r => r.slice(1).map(x=>+x));
        } catch { alert('डेटा लोड अयशस्वी'); }
        this.process();
        this.fillSelectors();
        this.updateAll();
        this.hideLoading();
      }
      process() {
        this.data.processed = this.data.talukas.map((t,i)=>{
          const ranks = this.data.rankings[i];
          const avg   = ranks.reduce((s,v)=>s+v,0)/ranks.length;
          const topSchemes = this.data.schemes.filter((_,sIdx) => ranks[sIdx] === 1);
          const badSchemes = this.data.schemes.filter((_,sIdx) => ranks[sIdx] === 15);
          return { t, avg: +avg.toFixed(2), topCount: topSchemes.length,
                   badCount: badSchemes.length, topSchemes, badSchemes, ranks };
        }).sort((a,b)=>a.avg-b.avg);
      }
      fillSelectors() {
        let ss=document.getElementById('schemeSelect'), ts=document.getElementById('talukaSelect');
        ss.innerHTML='<option value="all">सर्व योजना</option>';
        ts.innerHTML='';
        this.data.schemes.forEach((s,i)=>ss.add(new Option(s,i)));
        this.data.talukas.forEach(t=>{
          const opt=document.createElement('option'); opt.value=t; opt.text=t; ts.appendChild(opt);
        });
      }
      updateAll() {
        const talSel = document.getElementById('talukaSelect');
        this.currentTalukas = Array.from(talSel.selectedOptions).map(o=>o.value);
        this.updateKPIs();
        this.updateTable();
        this.updateCharts();
      }
      updateKPIs() {
        let selected = this.currentTalukas.length ? this.data.processed.filter(x=>this.currentTalukas.includes(x.t)) : this.data.processed.slice(0,3);
        document.getElementById('kpiCards').innerHTML = selected.map(x => `
          <div class="col-md-4 mb-3">
            <div class="card bg-success text-white h-100">
              <div class="card-body d-flex align-items-center">
                <i class="fas fa-trophy kpi-icon"></i>
                <div>
                  <h5 class="mb-1">${x.t}</h5>
                  <div><strong>टॉप योजनांची संख्या:</strong> ${x.topCount} </div>
                  <div class="small mt-2"><span class="text-white-50">(${x.topSchemes.join(', ') || '—'})</span></div>
                  <div><strong>सुधारणा आवश्यक:</strong> ${x.badCount}</div>
                  <div class="small mt-2"><span class="text-white-50">(${x.badSchemes.join(', ') || '—'})</span></div>
                </div>
              </div>
            </div>
          </div>
        `).join('');
      }
      updateTable() {
        let arr = this.currentTalukas.length
          ? this.data.processed.filter(x => this.currentTalukas.includes(x.t))
          : this.data.processed;
        const hdr = document.getElementById('tableHeader');
        const bd = document.querySelector('#rankingTable tbody');
        hdr.innerHTML = `<th>तालुका</th><th>टॉप योजनांची संख्या</th><th>योजना (टॉप)</th><th>सुधारणा आवश्यक योजना</th><th>योजना (कमकुवत)</th>`;
        bd.innerHTML = arr.map((x,i)=>`
          <tr class="${i<3?'table-row-top3':i<8?'table-row-mid5':'table-row-bottom5'}">
            <td>${x.t}</td>
            <td>${x.topCount}</td>
            <td>${x.topSchemes.length ? x.topSchemes.map(s=>`<span class="badge bg-success">${s}</span>`).join(' ') : '—'}</td>
            <td>${x.badCount}</td>
            <td>${x.badSchemes.length ? x.badSchemes.map(s=>`<span class="badge bg-danger">${s}</span>`).join(' ') : '—'}</td>
          </tr>
        `).join('');
      }
      updateCharts() {
        let arr = this.data.processed;
        this.draw('topChart', arr.slice(0,3), '#28a745', 'Top 3');
        this.draw('bottomChart', arr.slice(-5).reverse(),'#dc3545','Bottom 5');
      }
      draw(id,arr,color,label) {
        let ctx = document.getElementById(id).getContext('2d');
        if(this.charts[id]) this.charts[id].destroy();
        this.charts[id] = new Chart(ctx,{
          type:'bar',
          data:{ labels: arr.map(x=>x.t), datasets:[{label,data:arr.map(x=>x.topCount), backgroundColor: color, borderRadius:5}]},
          options:{ indexAxis:'y', responsive:true, plugins:{legend:{display:true,position:'top'}},scales:{x:{beginAtZero:true}}}
        });
      }
      fillSummary() {
        const talukas = this.currentTalukas.length ? this.currentTalukas : this.data.talukas;
        const headRow = ['तालुका', ...this.data.schemes];
        document.getElementById('summaryHeader').innerHTML = headRow.map(h=>`<th>${h}</th>`).join('');
        document.getElementById('summaryBody').innerHTML = talukas.map(t=>{
          const idx = this.data.talukas.indexOf(t);
          const ranks = this.data.rankings[idx];
          return `<tr>
            <td class="summary-taluka">${t}</td>
            ${ranks.map((v, sIdx)=>{
              let cls = '';
              if(v === 1) cls = 'summary-top';
              else if(v === 15) cls = 'summary-bottom';
              else if(v<=3) cls = 'summary-top';
              else if(v>=13) cls = 'summary-bottom';
              else if(v>=4 && v<=6) cls = 'summary-med';
              return `<td class="${cls} summary-cell">${v}</td>`;
            }).join('')}
          </tr>`;
        }).join('');
      }
    }
    document.addEventListener('DOMContentLoaded', ()=>new Dashboard());
  </script>
</body>
</html>
