<!DOCTYPE html>
<html lang="mr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§∞‡§Å‡§ï‡§ø‡§Ç‡§ó ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§°</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body { font-family:'Noto Sans Devanagari',sans-serif; background:#f8f9fa;}
    .header-gradient { background: linear-gradient(135deg,#667eea,#764ba2);}
    .kpi-card { border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1);}
    .kpi-card i { font-size:2rem; margin-right:.65rem; }
    .kpi-card .fa-times-circle { color: #fff; background:#dc3545; border-radius:50%; padding:4px;}
    .chart-container { position:relative; height:305px;}
    .table-row-top5 { border-left:5px solid #28a745; background:rgba(40,167,69,0.11);}
    .table-row-bottom5 { border-left:5px solid #dc3545; background:rgba(220,53,69,0.09);}
    .table-row-middle { border-left:5px solid #ffc107; background:rgba(255,193,7,0.07);}
    .btn-primary, .btn-outline-secondary, .btn-warning { min-width:96px;}
    .form-select[multiple] { height:auto;}
    .loading-overlay { position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:9999;background:rgba(255,255,255,.92);display:none;align-items:center;justify-content:center;}
    .loading-spinner { width:3.5rem;height:3.5rem;border:4px solid #eee;border-top:4px solid #667eea;border-radius:50%;animation:spin 1s linear infinite;}
    @keyframes spin { 100% { transform:rotate(360deg); } }
  </style>
</head>
<body>
  <div id="loadingOverlay" class="loading-overlay"><div class="loading-spinner"></div></div>
  <header class="header-gradient py-4 mb-4 text-white">
    <div class="container d-flex justify-content-between align-items-center">
      <h1 class="mb-0"><i class="fas fa-chart-line me-2"></i>‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§∞‡§Å‡§ï‡§ø‡§Ç‡§ó ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§°</h1>
      <button id="refreshBtn" class="btn btn-light btn-lg"><i class="fas fa-sync-alt me-2"></i>‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡§æ</button>
    </div>
  </header>
  <div class="container">

    <!-- KPI Cards: Best (green/star), Worst (red/cross), Average (blue/chart) -->
    <div class="row mb-3" id="kpiCards"></div>

    <!-- Top5/Bottom5 charts (row just below KPI) -->
    <div class="row mb-3">
      <div class="col-md-6 mb-4"><div class="card">
        <div class="card-header bg-success text-white"><span><i class="fas fa-trophy me-2"></i>‡§∏‡§∞‡•ç‡§µ‡•ã‡§§‡•ç‡§ï‡•É‡§∑‡•ç‡§ü ‡•´ ‡§§‡§æ‡§≤‡•Å‡§ï‡•á</span></div>
        <div class="card-body"><div class="chart-container"><canvas id="topChart"></canvas></div></div>
      </div></div>
      <div class="col-md-6 mb-4"><div class="card">
        <div class="card-header bg-danger text-white"><span><i class="fas fa-times-circle me-2"></i>‡§ï‡§Æ‡§ï‡•Å‡§µ‡§§ ‡•´ ‡§§‡§æ‡§≤‡•Å‡§ï‡•á</span></div>
        <div class="card-body"><div class="chart-container"><canvas id="bottomChart"></canvas></div></div>
      </div></div>
    </div>

    <!-- Controls: Scheme + Taluka, both in same row -->
    <div class="row mb-4 align-items-end">
      <div class="col-md-4">
        <label class="form-label h5"><i class="fas fa-filter me-2"></i>‡§Ø‡•ã‡§ú‡§®‡§æ ‡§®‡§ø‡§µ‡§°‡§æ:</label>
        <select id="schemeSelect" class="form-select"></select>
      </div>
      <div class="col-md-4">
        <label class="form-label h5"><i class="fas fa-map-marker-alt me-2"></i>‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§®‡§ø‡§µ‡§°‡§æ:</label>
        <select id="talukaSelect" class="form-select" multiple size="6"></select>
      </div>
      <div class="col-md-4 text-center">
        <button id="submitBtn" class="btn btn-primary me-2">Submit</button>
        <button id="resetBtn" class="btn btn-outline-secondary">Reset</button>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-header bg-primary text-white"><h5 class="mb-0"><i class="fas fa-table me-2"></i>‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§∞‡§Å‡§ï‡§ø‡§Ç‡§ó ‡§ü‡•á‡§¨‡§≤</h5></div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table id="rankingTable" class="table table-hover mb-0">
            <thead>
              <tr>
                <th>‡§§‡§æ‡§≤‡•Å‡§ï‡§æ</th>
                <th>‡§∏‡§∞‡§æ‡§∏‡§∞‡•Ä ‡§∞‡§Å‡§ï</th>
                <th>‡§ü‡•â‡§™ ‡§Ø‡•ã‡§ú‡§®‡§æ‡§Ç‡§ö‡•Ä ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // CONFIG
    const SHEET_ID = '1aINSij-6mXtt4Gbocn0A1PHbuh7XMImHL0zFmdVKhVs';
    const API_KEY  = 'AIzaSyBmci6WRXJCilTloJnQ1F6gc2qg1aJ96o0';
    const RANGE    = 'Rank!B5:AI20';
    const API_URL  = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
    let dashboard;

    class Dashboard {
      constructor(){
        this.talukas=[]; this.schemes=[]; this.rankings=[];
        this.processed=[]; this.selectedSchemes='all'; this.selectedTalukas=[];
        this.charts={};
        this.init();
      }
      init(){
        document.getElementById('refreshBtn').onclick = ()=>this.load();
        document.getElementById('submitBtn').onclick = ()=>this.updateAll();
        document.getElementById('resetBtn').onclick = ()=>window.location.reload();
        this.load();
      }
      showLoading(){document.getElementById('loadingOverlay').style.display='flex';}
      hideLoading(){document.getElementById('loadingOverlay').style.display='none';}
      async load(){
        this.showLoading();
        try{
          const resp=await fetch(API_URL);
          const v=(await resp.json()).values;
          this.schemes=v[0].slice(1);
          this.talukas=v.slice(1).map(r=>r[0]).filter(Boolean);
          this.rankings=v.slice(1).map(r=>r.slice(1).map(x=>+x));
          this.fillSelectors();
        }catch{ alert('‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§Ö‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä'); }
        this.process();
        this.updateAll();
        this.hideLoading();
      }
      process(){
        this.processed = this.talukas.map((t,i)=>{
          const r=this.rankings[i];
          return {
            t,
            avg: +(r.reduce((a,b)=>a+b,0)/r.length).toFixed(2),
            topCount: r.filter(x=>x===1).length,
            ranks: r
          };
        });
      }
      fillSelectors(){
        const ss=document.getElementById('schemeSelect'), ts=document.getElementById('talukaSelect');
        ss.innerHTML = '<option value="all">‡§∏‡§∞‡•ç‡§µ ‡§Ø‡•ã‡§ú‡§®‡§æ</option>' + this.schemes.map((s,j)=>`<option value="${j}">${s}</option>`).join('');
        ts.innerHTML = '';
        this.talukas.forEach(t=>{const o=document.createElement('option');o.value=t;o.text=t;ts.add(o);});
        ss.value='all';
      }
      updateAll(){
        // get filters
        const s=document.getElementById('schemeSelect').value,
              sel=document.getElementById('talukaSelect');
        let tarr=Array.from(sel.selectedOptions).map(o=>o.value);
        this.selectedSchemes=s; this.selectedTalukas=tarr;

        // filter + sort
        let arr = (tarr.length>0)
          ? this.processed.filter(x=>tarr.includes(x.t))
          : this.processed;

        // table/logic if filtered to specific scheme
        if(s !== "all") {
          const idx=+s;
          arr = arr
            .map(x=>({
              t:x.t,
              avg: x.ranks[idx],
              topCount: x.ranks[idx]===1 ? 1 : 0
            }))
            .sort((a,b)=>a.avg-b.avg);
        } else {
          arr=arr.slice().sort((a,b)=>a.avg-b.avg);
        }
        this.showKPIs(arr);
        this.showTable(arr,s);
        this.showCharts(s);
      }
      showKPIs(arr){
        // Top, Bottom, Average - green/red/blue with emoji, no rank: only plain value
        if(!arr.length) return document.getElementById('kpiCards').innerHTML='';
        let best=arr[0], worst=arr[arr.length-1], avg=(arr.map(x=>+x.avg).reduce((a,b)=>a+b,0)/arr.length).toFixed(2);

        document.getElementById('kpiCards').innerHTML = `
          <div class="col-md-4 mb-3">
            <div class="card kpi-card bg-success text-white h-100">
              <div class="card-body d-flex align-items-center">
                <i class="fas fa-star"></i>
                <div>
                  <h5 class="mb-1">‡§∏‡§∞‡•ç‡§µ‡•ã‡§§‡•ç‡§§‡§Æ ‡§§‡§æ‡§≤‡•Å‡§ï‡§æ</h5>
                  <div><strong>${best.t} ‚≠êÔ∏è</strong></div>
                  <div>‡§ü‡•â‡§™ ‡§Ø‡•ã‡§ú‡§®‡§æ‡§Ç‡§ö‡•Ä ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ: <b>${best.topCount}</b></div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4 mb-3">
            <div class="card kpi-card bg-danger text-white h-100">
              <div class="card-body d-flex align-items-center">
                <i class="fas fa-times-circle"></i>
                <div>
                  <h5 class="mb-1">‡§∏‡•Å‡§ß‡§æ‡§∞‡§£‡§æ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï</h5>
                  <div><strong>${worst.t} ‚ùå</strong></div>
                  <div>‡§ü‡•â‡§™ ‡§Ø‡•ã‡§ú‡§®‡§æ‡§Ç‡§ö‡•Ä ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ: <b>${worst.topCount}</b></div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4 mb-3">
            <div class="card kpi-card bg-primary text-white h-100">
              <div class="card-body d-flex align-items-center">
                <i class="fas fa-chart-bar"></i>
                <div>
                  <h5 class="mb-1">‡§ú‡§ø‡§≤‡•ç‡§π‡§æ ‡§∏‡§∞‡§æ‡§∏‡§∞‡•Ä</h5>
                  <div>üìä <strong>${avg}</strong></div>
                </div>
              </div>
            </div>
          </div>`;
      }
      showTable(arr,schemeSelVal){
        let tbody='';
        arr.forEach((x,i)=>{
          let trclass = i<5 ? 'table-row-top5' : i>=arr.length-5 ? 'table-row-bottom5' : 'table-row-middle';
          tbody += `<tr class="${trclass}">
            <td>${x.t}</td>
            <td>${x.avg}</td>
            <td>${x.topCount}</td></tr>`;
        });
        document.querySelector('#rankingTable tbody').innerHTML=tbody;
      }
      showCharts(schemeSelVal){
        let arr, topTitle, botTitle;
        if(schemeSelVal==="all"){
          arr = this.processed.slice().sort((a,b)=>a.avg-b.avg);
          topTitle="‡§∏‡§∞‡•ç‡§µ‡•ã‡§§‡•ç‡§ï‡•É‡§∑‡•ç‡§ü ‡•´ ‡§§‡§æ‡§≤‡•Å‡§ï‡•á"; botTitle="‡§ï‡§Æ‡§ï‡•Å‡§µ‡§§ ‡•´ ‡§§‡§æ‡§≤‡•Å‡§ï‡•á";
        }else{
          let idx = +schemeSelVal;
          arr = this.processed.map(x=> ({
            t:x.t,
            y: x.ranks[idx]
          })).sort((a,b)=>a.y-b.y);
          topTitle = `"${this.schemes[idx]}" ‡§∏‡§∞‡•ç‡§µ‡•ã‡§§‡•ç‡§§‡§Æ ‡•´ ‡§§‡§æ‡§≤‡•Å‡§ï‡•á`;
          botTitle = ` "${this.schemes[idx]}" ‡§ï‡§Æ‡§ï‡•Å‡§µ‡§§ ‡•´ ‡§§‡§æ‡§≤‡•Å‡§ï‡•á`;
        }
        // Top 5
        let ctx=document.getElementById('topChart').getContext('2d');
        if(this.charts['topChart']) this.charts['topChart'].destroy();
        this.charts['topChart']=new Chart(ctx,{
          type:'bar',
          data:{labels: arr.slice(0,5).map(x=>x.t),datasets:[{data: arr.slice(0,5).map(x=>(x.avg!==undefined?x.avg:x.y)), backgroundColor:'#28a745', borderRadius:5}]},
          options:{indexAxis:'y',responsive:true,plugins:{legend:{display:false},title:{display:true,text:topTitle,font:{size:17}}},scales:{x:{beginAtZero:true}}}
        });
        // Bottom 5
        ctx=document.getElementById('bottomChart').getContext('2d');
        if(this.charts['bottomChart']) this.charts['bottomChart'].destroy();
        this.charts['bottomChart']=new Chart(ctx,{
          type:'bar',
          data:{labels: arr.slice(-5).reverse().map(x=>x.t),datasets:[{data: arr.slice(-5).reverse().map(x=>(x.avg!==undefined?x.avg:x.y)), backgroundColor:'#dc3545', borderRadius:5}]},
          options:{indexAxis:'y',responsive:true,plugins:{legend:{display:false},title:{display:true,text:botTitle,font:{size:17}}},scales:{x:{beginAtZero:true}}}
        });
      }
    }

    document.addEventListener('DOMContentLoaded',()=>dashboard=new Dashboard());

    // Populate schemes dropdown once data arrives (wait for dashboard to init)
    setTimeout(()=>{
      if(dashboard && dashboard.schemes){
        const ss=document.getElementById('schemeSelect');
        if(!ss.options.length) dashboard.fillSelectors();
      }
    },900);
  </script>
</body>
</html>
