<!DOCTYPE html>
<html lang="mr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>तालुका योजना रँकिंग डॅशबोर्ड</title>
  <!-- Fonts & CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body { font-family:'Noto Sans Devanagari',sans-serif; background:#f8f9fa; }
    .header-gradient { background: linear-gradient(135deg,#667eea,#764ba2); }
    .kpi-card { border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
    .kpi-card i { font-size:2rem; margin-right:.8rem; }
    .table-row-top3 { border-left:5px solid #28a745; background:rgba(40,167,69,0.1); }
    .table-row-mid5 { border-left:5px solid #ffc107; background:rgba(255,193,7,0.1); }
    .table-row-bottom5 { border-left:5px solid #dc3545; background:rgba(220,53,69,0.06); }
    .chart-container { position:relative;height:300px; }
    .loading-overlay { position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(255,255,255,0.9);display:none;align-items:center;justify-content:center;z-index:9999; }
    .loading-spinner { width:3.5rem;height:3.5rem;border:4px solid #eee;border-top:4px solid #667eea;border-radius:50%;animation:spin 1s linear infinite; }
    @keyframes spin { 100% { transform:rotate(360deg); } }
  </style>
</head>
<body>
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
  </div>

  <header class="header-gradient py-4 mb-4 text-white">
    <div class="container d-flex justify-content-between align-items-center">
      <h1 class="mb-0"><i class="fas fa-chart-line me-2"></i>तालुका योजना रँकिंग डॅशबोर्ड</h1>
      <button id="refreshBtn" class="btn btn-light btn-lg">
        <i class="fas fa-sync-alt me-2"></i>डेटा रिफ्रेश करा
      </button>
    </div>
  </header>

  <div class="container">
    <!-- KPI Cards -->
    <div class="row mb-3" id="kpiCards"></div>

    <!-- Charts Row -->
    <div class="row mb-3">
      <div class="col-md-6 mb-4" id="topChartContainer">
        <div class="card">
          <div class="card-header bg-success text-white d-flex align-items-center">
            <i class="fas fa-trophy me-2"></i><span id="topChartTitle">Top 3 Talukas</span>
          </div>
          <div class="card-body"><div class="chart-container"><canvas id="topChart"></canvas></div></div>
        </div>
      </div>
      <div class="col-md-6 mb-4" id="bottomChartContainer">
        <div class="card">
          <div class="card-header bg-danger text-white d-flex align-items-center">
            <i class="fas fa-exclamation-triangle me-2"></i><span id="bottomChartTitle">Bottom 5 Talukas</span>
          </div>
          <div class="card-body"><div class="chart-container"><canvas id="bottomChart"></canvas></div></div>
        </div>
      </div>
    </div>

    <!-- Controls -->
    <div class="row mb-4 align-items-end">
      <div class="col-md-6">
        <label class="form-label h5"><i class="fas fa-map-marker-alt me-2"></i>तालुका निवडा:</label>
        <select id="talukaSelect" class="form-select" multiple size="6"></select>
      </div>
      <div class="col-md-6 text-center">
        <button id="submitBtn" class="btn btn-primary me-2">Submit</button>
        <button id="resetBtn" class="btn btn-outline-secondary">Reset</button>
      </div>
    </div>

    <!-- Ranking Table -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="fas fa-table me-2"></i>तालुका रँकिंग टेबल</h5>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table id="rankingTable" class="table table-hover mb-0">
            <thead>
              <tr>
                <th>तालुका</th>
                <th>सरासरी रँक</th>
                <th>टॉप योजनांची संख्या</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const SHEET_ID='1aINSij-6mXtt4Gbocn0A1PHbuh7XMImHL0zFmdVKhVs';
    const API_KEY='AIzaSyBmci6WRXJCilTloJnQ1F6gc2qg1aJ96o0';
    const RANGE='Rank!B5:AI20';
    const API_URL=`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;

    class Dashboard {
      constructor(){
        this.data={talukas:[],schemes:[],rankings:[],processed:[]};
        this.currentTalukas=[];
        this.charts={};
        this.init();
      }
      init(){
        document.getElementById('refreshBtn').onclick=()=>this.load();
        document.getElementById('submitBtn').onclick=()=>this.updateAll();
        document.getElementById('resetBtn').onclick=()=>location.reload();
        this.load();
      }
      showLoading(){document.getElementById('loadingOverlay').style.display='flex';}
      hideLoading(){document.getElementById('loadingOverlay').style.display='none';}
      async load(){
        this.showLoading();
        try{
          const resp=await fetch(API_URL);
          const v=(await resp.json()).values;
          this.data.talukas=v.slice(1).map(r=>r[0]).filter(Boolean);
          this.data.rankings=v.slice(1).map(r=>r.slice(1).map(x=>+x));
        }catch{alert('डेटा लोड अयशस्वी');}
        this.process(); this.fillSelectors(); this.updateAll(); this.hideLoading();
      }
      process(){
        this.data.processed=this.data.talukas.map((t,i)=>{
          const r=this.data.rankings[i];
          const avg=(r.reduce((a,b)=>a+b,0)/r.length).toFixed(2);
          const topCount=r.filter(x=>x===1).length;
          return {t,avg,topCount};
        });
      }
      fillSelectors(){
        const ts=document.getElementById('talukaSelect');
        ts.innerHTML='';
        this.data.talukas.forEach(t=>{const o=document.createElement('option');o.value=t;o.text=t;ts.add(o);});
      }
      updateAll(){
        const sel=document.getElementById('talukaSelect');
        this.currentTalukas=Array.from(sel.selectedOptions).map(o=>o.value);
        this.showKPIs(); this.showTable(); this.showCharts();
      }
      showKPIs(){
        const arr=this.currentTalukas.length ? 
          this.data.processed.filter(x=>this.currentTalukas.includes(x.t)) :
          this.data.processed.slice(0,3);
        document.getElementById('kpiCards').innerHTML=arr.map(x=>`
          <div class="col-md-4 mb-3">
            <div class="card kpi-card bg-success text-white h-100">
              <div class="card-body d-flex align-items-center">
                <i class="fas fa-star"></i>
                <div>
                  <h5 class="mb-1">${x.t}</h5>
                  <div>सरासरी रँक: <strong>${x.avg}</strong></div>
                  <div>टॉप योजनांची संख्या: <strong>${x.topCount}</strong></div>
                </div>
              </div>
            </div>
          </div>`).join('');
      }
      showTable(){
        const arr=this.currentTalukas.length ? 
          this.data.processed.filter(x=>this.currentTalukas.includes(x.t)):
          this.data.processed;
        document.querySelector('#rankingTable tbody').innerHTML=arr.map((x,i)=>`
          <tr class="${i<3?'table-row-top3':i<8?'table-row-mid5':'table-row-bottom5'}">
            <td>${x.t}</td>
            <td>${x.avg}</td>
            <td>${x.topCount}</td>
          </tr>`).join('');
      }
      showCharts(){
        const arr=this.data.processed;
        this.draw('topChart',arr.slice(0,3),'#28a745','Top 3');
        this.draw('bottomChart',arr.slice(-5).reverse(),'#dc3545','Bottom 5');
      }
      draw(id,arr,color,label){
        const ctx=document.getElementById(id).getContext('2d');
        if(this.charts[id])this.charts[id].destroy();
        this.charts[id]=new Chart(ctx,{
          type:'bar',
          data:{labels:arr.map(x=>x.t),datasets:[{label,data:arr.map(x=>x.topCount),backgroundColor:color,borderRadius:5}]},
          options:{indexAxis:'y',responsive:true,plugins:{legend:{display:true,position:'top'}},scales:{x:{beginAtZero:true}}}
        });
      }
    }
    document.addEventListener('DOMContentLoaded',()=>new Dashboard());
  </script>
</body>
</html>
