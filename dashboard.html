<!DOCTYPE html>
<html lang="mr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ЁЯФР рд╕реБрд░рдХреНрд╖рд┐рдд рддрд╛рд▓реБрдХрд╛ рдбреЕрд╢рдмреЛрд░реНрдб</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body { background: #f9fbff; font-family: 'Segoe UI', sans-serif; }
    .card-glass { background: #fff; border-radius: 10px; box-shadow: 0 5px 10px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 20px; }
    .form-select { min-height: 160px; }
    canvas { max-height: 360px; }
  </style>
</head>
<body>
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3>ЁЯПЕ рддрд╛рд▓реБрдХрд╛ рд░рдБрдХрд┐рдВрдЧ рдбреЕрд╢рдмреЛрд░реНрдб (рд╕реБрд░рдХреНрд╖рд┐рдд)</h3>
    <a href="ai-insights.html" class="btn btn-outline-primary">ЁЯдЦ AI Insights</a>
  </div>

  <div class="row text-center mb-3">
    <div class="col-md-4">
      <div class="card-glass bg-success text-white">
        <h5>ЁЯПЖ Top 5 Talukas</h5><div id="topTaluka"></div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card-glass bg-warning text-dark">
        <h5>ЁЯШР Middle 5 Talukas</h5><div id="middleTaluka"></div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card-glass bg-danger text-white">
        <h5>тЪая╕П Bottom 5 Talukas</h5><div id="bottomTaluka"></div>
      </div>
    </div>
  </div>

  <div class="card-glass">
    <h5>ЁЯУМ рдмрд╣реБ рдпреЛрдЬрдирд╛ рд╡ рдмрд╣реБ рддрд╛рд▓реБрдХрд╛ рддреБрд▓рдирд╛:</h5>
    <div class="row">
      <div class="col-md-6">
        <label>тЬЕ рдпреЛрдЬрдирд╛ рдирд┐рд╡рдбрд╛ (рдПрдХрд╛рдзрд┐рдХ):</label>
        <select multiple class="form-select" id="schemeSelect"></select>
        <button class="btn btn-sm btn-outline-primary mt-2" onclick="selectAll('schemeSelect')">рд╕рд░реНрд╡ рдирд┐рд╡рдбрд╛</button>
      </div>
      <div class="col-md-6">
        <label>ЁЯПШя╕П рддрд╛рд▓реБрдХрд╛ рдирд┐рд╡рдбрд╛ (рдПрдХрд╛рдзрд┐рдХ):</label>
        <select multiple class="form-select" id="talukaSelect"></select>
        <button class="btn btn-sm btn-outline-primary mt-2" onclick="selectAll('talukaSelect')">рд╕рд░реНрд╡ рдирд┐рд╡рдбрд╛</button>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-md-6 card-glass">
      <h6 class="text-center">ЁЯУИ рдпреЛрдЬрдирд╛ рдЖрдзрд╛рд░рд┐рдд рддрд╛рд▓реБрдХрд╛ рд░рдБрдХрд┐рдВрдЧ</h6>
      <canvas id="schemeChart"></canvas>
    </div>
    <div class="col-md-6 card-glass">
      <h6 class="text-center">ЁЯУК рддрд╛рд▓реБрдХрд╛ рдЖрдзрд╛рд░рд┐рдд рдпреЛрдЬрдирд╛ рдХрд╛рдордЧрд┐рд░реА</h6>
      <canvas id="talukaChart"></canvas>
    </div>
  </div>
</div>

<script>
const PROXY_URL = "https://yourworker.example.workers.dev"; // ЁЯФБ REPLACE WITH YOUR CLOUDLFARE WORKER URL

async function fetchSheetData() {
  const rangeData = await fetch(PROXY_URL, { headers: { "X-Range": "C6:AI20" } }).then(r => r.json());
  const rangeHeader = await fetch(PROXY_URL, { headers: { "X-Range": "C5:AI5" } }).then(r => r.json());
  const rangeTalukas = await fetch(PROXY_URL, { headers: { "X-Range": "B6:B20" } }).then(r => r.json());

  return {
    header: rangeHeader.values[0],
    rows: rangeData.values,
    talukas: rangeTalukas.values.flat()
  };
}

function selectAll(id) {
  const select = document.getElementById(id);
  for (let opt of select.options) opt.selected = true;
  select.dispatchEvent(new Event('change'));
}

function buildDropdowns(schemes, talukas) {
  const sSelect = document.getElementById("schemeSelect");
  const tSelect = document.getElementById("talukaSelect");
  schemes.forEach(sc => {
    const opt = document.createElement("option");
    opt.text = sc; opt.value = sc;
    sSelect.appendChild(opt);
  });
  talukas.forEach(t => {
    const opt = document.createElement("option");
    opt.text = t; opt.value = t;
    tSelect.appendChild(opt);
  });
}

function renderKPI(dataMap) {
  const rankCount = {};
  for (let taluka in dataMap) {
    let count1 = dataMap[taluka].filter(d => d.rank == 1).length;
    rankCount[taluka] = count1;
  }
  const sorted = Object.entries(rankCount).sort((a,b)=>b[1]-a[1]).map(x=>x[0]);
  const top = sorted.slice(0,5).map(t => "ЁЯеЗ " + t).join("<br>");
  const mid = sorted.slice(5,10).map(t => "ЁЯШР " + t).join("<br>");
  const bot = sorted.slice(-5).map(t => "тЪая╕П " + t).join("<br>");
  document.getElementById("topTaluka").innerHTML = top;
  document.getElementById("middleTaluka").innerHTML = mid;
  document.getElementById("bottomTaluka").innerHTML = bot;
}

function renderCharts(dataMap, selectedSchemes, selectedTalukas) {
  let schemeCtx = document.getElementById("schemeChart").getContext("2d");
  let talukaCtx = document.getElementById("talukaChart").getContext("2d");

  if (window.schemeChart) window.schemeChart.destroy();
  if (window.talukaChart) window.talukaChart.destroy();

  window.schemeChart = new Chart(schemeCtx, {
    type: "bar",
    data: {
      labels: selectedTalukas,
      datasets: selectedSchemes.map(s => ({
        label: s,
        data: selectedTalukas.map(t => {
          const d = dataMap[t].find(e => e.scheme === s);
          return d ? d.rank : null;
        })
      }))
    },
    options: {
      responsive: true,
      scales: {
        y: { reverse: true, ticks: { stepSize: 1, precision:0 } }
      },
      plugins: {
        legend: { position: 'bottom' }
      }
    }
  });

  window.talukaChart = new Chart(talukaCtx, {
    type: "bar",
    data: {
      labels: selectedSchemes,
      datasets: selectedTalukas.map(t => ({
        label: t,
        data: selectedSchemes.map(s => {
          const d = dataMap[t].find(e => e.scheme === s);
          return d ? d.rank : null;
        })
      }))
    },
    options: {
      responsive: true,
      scales: {
        y: { reverse: true, ticks: { stepSize: 1, precision:0 } }
      },
      plugins: {
        legend: { position: 'bottom' }
      }
    }
  });
}

window.addEventListener("load", async () => {
  const raw = await fetchSheetData();
  const schemes = raw.header;
  const talukas = raw.talukas;

  buildDropdowns(schemes, talukas);

  const dataMap = {};
  talukas.forEach((t, idx) => {
    dataMap[t] = schemes.map((s, i) => ({ scheme: s, rank: parseInt(raw.rows[idx][i]) }));
  });

  renderKPI(dataMap);

  document.getElementById("schemeSelect").addEventListener("change", () => {
    const s = Array.from(document.getElementById("schemeSelect").selectedOptions).map(o=>o.value);
    const t = Array.from(document.getElementById("talukaSelect").selectedOptions).map(o=>o.value);
    if (s.length && t.length) renderCharts(dataMap, s, t);
  });

  document.getElementById("talukaSelect").addEventListener("change", () => {
    const s = Array.from(document.getElementById("schemeSelect").selectedOptions).map(o=>o.value);
    const t = Array.from(document.getElementById("talukaSelect").selectedOptions).map(o=>o.value);
    if (s.length && t.length) renderCharts(dataMap, s, t);
  });
});
</script>
</body>
</html>
