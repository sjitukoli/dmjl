<!DOCTYPE html>
<html lang="mr">
<head>
  <meta charset="UTF-8">
  <title>‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <style>
    body { font-family: 'Noto Sans Devanagari', sans-serif; background:#f7fafc; color:#23263a; margin:0; padding:1rem; }
    .glass { background:#fff; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-bottom:1rem; padding:1rem; }
    .nav-switcher .nav-link { cursor:pointer; transition:0.2s; }
    .nav-switcher .nav-link.active { background:#6366f1; color:#fff; }
    .kpi-card { border-radius:50px; text-align:center; padding:0.6rem; margin:0.5rem 0; position:relative;
      transition:0.2s; border:2px solid transparent; cursor:pointer; }
    .kpi-card:hover { border-color:#6366f1; box-shadow:0 2px 8px rgba(99,102,241,0.3); }
    .kpi-icon { font-size:1.6em; }
    .kpi-card.top .kpi-icon { animation:blink 1.2s infinite; color:#10b981; }
    @keyframes blink {0%,50%,100%{opacity:1}25%,75%{opacity:0.3}}
    .kpi-name { font-size:1em; margin:0.2rem 0; }
    .kpi-val { font-size:1.2em; font-weight:700; }
    .dept-chip { display:inline-block; padding:4px 8px; margin:3px; border-radius:12px; background:#e0e7ff;
      cursor:pointer; transition:0.15s; user-select:none; }
    .dept-chip.selected, .dept-chip:hover { background:#fbbf24; color:#92400e; transform:scale(1.05); }
    .chart-container { width:100%; height:250px; }
    .chart-header { text-align:center; font-weight:700; margin-bottom:0.5rem; }
    .btn-anim { transition:0.2s; }
    .btn-anim:hover { transform:scale(1.05); }
    .table thead th { background:#6366f1; color:#fff; text-align:center; }
    .table tbody td { text-align:center; }
    .selected-block td { background:#dbeafe!important; font-weight:700; }
    @media(max-width:1100px){.chart-container{height:200px}}
  </style>
</head>
<body>

<div class="container-fluid">

  <!-- Page 1 -->
  <div id="page1">
    <h2 class="text-center mb-3">üìä ‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§§‡•Å‡§≤‡§®‡§æ‡§§‡•ç‡§Æ‡§ï ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§°</h2>
    <div class="glass">
      <div class="row">
        <div class="col-md-6">
          <select id="schemeSelect" class="form-select form-select-sm" multiple></select>
        </div>
        <div class="col-md-6">
          <div id="talukaChips"></div>
        </div>
      </div>
      <div class="text-end mt-2">
        <button id="resetBtn" class="btn btn-outline-danger btn-sm btn-anim">Reset</button>
        <button id="updateBtn" class="btn btn-primary btn-sm btn-anim">Update</button>
      </div>
    </div>

    <div class="glass d-flex gap-3">
      <div class="flex-fill">
        <div class="chart-header">üèÜ KPI</div>
        <div id="kpiCol"></div>
      </div>
      <div class="flex-fill">
        <div class="chart-header">üìà ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§™‡•ç‡§∞‡§¶‡§∞‡•ç‡§∂‡§® ‡§§‡•Å‡§≤‡§®‡§æ</div>
        <canvas id="barChart" class="chart-container"></canvas>
        <button id="dlBar" class="btn btn-success btn-sm btn-compact btn-anim">‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</button>
      </div>
      <div class="flex-fill">
        <div class="chart-header">üìä ‡§™‡•ç‡§∞‡§§‡§ø‡§∂‡§§ ‡§µ‡§æ‡§ü‡§™</div>
        <canvas id="donutChart" class="chart-container"></canvas>
        <button id="dlDonut" class="btn btn-warning btn-sm btn-compact btn-anim">‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</button>
      </div>
    </div>

    <div class="glass mt-3">
      <h6 class="mb-2">üìã ‡§§‡§æ‡§≤‡•Å‡§ï‡•ç‡§Ø‡§æ‡§Ç‡§ö‡•Ä ‡§∏‡§Ç‡§™‡•Ç‡§∞‡•ç‡§£ ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§µ ‡§∞‡§Å‡§ï‡§ø‡§Ç‡§ó</h6>
      <div class="table-responsive" style="max-height:300px; overflow:auto;">
        <table class="table" id="tableMain">
          <thead><tr id="tblHead"></tr></thead>
          <tbody id="tblBody"></tbody>
        </table>
      </div>
      <div class="text-end mt-1">
        <button id="dlCsv" class="btn btn-secondary btn-compact btn-anim">üìä CSV</button>
      </div>
    </div>
  </div>

  <!-- Page 2 -->
  <div id="page2" style="display:none;">
    <ul class="nav nav-pills nav-switcher mb-3">
      <li class="nav-item"><a class="nav-link active" data-type="top">TOP 5</a></li>
      <li class="nav-item"><a class="nav-link" data-type="mid">‡§Æ‡§ß‡•ç‡§Ø‡§Æ 5</a></li>
      <li class="nav-item"><a class="nav-link" data-type="bot">‡§§‡§≥ 5</a></li>
    </ul>

    <div class="glass">
      <div class="row">
        <div class="col-lg-4" id="page2KPI"></div>
        <div class="col-lg-4">
          <div class="chart-header">üóÇ ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§∞‡§Å‡§ï ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£</div>
          <canvas id="schemeRankChart2" class="chart-container"></canvas>
        </div>
        <div class="col-lg-4">
          <div class="chart-header">üîç ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∑‡§Æ‡§§‡§æ ‡§§‡§™‡§∂‡•Ä‡§≤</div>
          <div id="detailSection"></div>
        </div>
      </div>
    </div>

    <div class="mt-3 text-center">
      <button class="btn btn-outline-primary btn-compact" onclick="showPage(1)">‚Üê ‡§Æ‡•Å‡§ñ‡•ç‡§Ø</button>
    </div>
  </div>

</div>

<script>
  let rawData, headers, schemes, selectedBlocks=new Set(), selectedSchemes=new Set();
  let barChart, donutChart, schemeRankChart, schemeRankChart2;

  async function init(){
    const vals=await fetch('https://sheets.googleapis.com/v4/spreadsheets/'+
      '1y_EVqNg-reS3xV-Kn6cmTou7u_6kuyqykNdgdzXEMkE/values/Rank!B5:AJ20?key=AIzaSyDhCjnUv7x5yj9cXKV52Qv8CrYwUhBIWuU'
    ).then(r=>r.json()).then(d=>d.values);
    headers=vals[0];
    rawData=vals.slice(1).map(r=>{
      let o={};headers.forEach((h,i)=>o[h]=r[i]);o._block=r[0];return o;
    });
    schemes=headers;
    renderControls();
    showAll();
  }

  function renderControls(){
    const s=document.getElementById('schemeSelect');
    s.innerHTML=schemes.map(v=>`<option>${v}</option>`).join('');
    document.querySelectorAll('#talukaChips').forEach(_=>{
      document.getElementById('talukaChips').innerHTML=
        rawData.map(r=>`<span class="dept-chip">${r._block}</span>`).join('');
    });
    document.querySelectorAll('.dept-chip').forEach(el=>el.onclick=()=>{el.classList.toggle('selected')});
    document.getElementById('updateBtn').onclick=showAll;
    document.getElementById('dlBar').onclick=()=>downloadChart(barChart,'bar.png');
    document.getElementById('dlDonut').onclick=()=>downloadChart(donutChart,'donut.png');
    document.getElementById('dlCsv').onclick=downloadCSV;
  }

  function showAll(){
    document.getElementById('page1').style.display='';
    document.getElementById('page2').style.display='none';
    // use all
    selectedSchemes.clear();schemes.forEach(s=>selectedSchemes.add(s));
    selectedBlocks.clear();rawData.forEach(r=>selectedBlocks.add(r._block));
    renderDashboard();
  }

  function renderDashboard(){
    const KPI=getRankOnes();
    renderKPI(KPI);
    renderBar(KPI);
    renderDonut(KPI);
    renderTable(KPI);
  }

  function getRankOnes(){
    let cnt={};schemes.forEach(s=>{
      let best=Infinity,top=[];
      rawData.forEach(r=>{let rk=parseInt(r[s])||999;if(rk<best){best=rk;top=[r._block];}else if(rk===best)top.push(r._block)});
      if(best===1)top.forEach(t=>cnt[t]=(cnt[t]||0)+1);
    });
    let arr=rawData.map(r=>({b:r._block,ones:cnt[r._block]||0}));
    arr.sort((a,b)=>b.ones-a.ones);
    arr.forEach((x,i)=>x.rank=i+1);
    return arr;
  }

  function renderKPI(data){
    const col=document.getElementById('kpiCol');col.innerHTML='';
    [['top','fa-trophy'],['mid','fa-balance-scale'],['bot','fa-exclamation-circle']].forEach((c,i)=>{
      let it=data[i===0?0:i===1?Math.floor(data.length/2):data.length-1];
      col.innerHTML+=`
      <div class="kpi-card ${c[0]}${i===0?' blink':''}" onclick="togglePage2('${it.b}')">
        <i class="fas ${c[1]} kpi-icon"></i>
        <div class="kpi-name">${it.b}</div>
        <div class="kpi-score">${it.ones} #1s</div>
      </div>`;
    });
  }

  function renderBar(data){
    const ctx=document.getElementById('barChart').getContext('2d');
    barChart&&barChart.destroy();
    const pal=['#6366f1','#10b981','#f59e0b','#ef4444','#3b82f6'];
    barChart=new Chart(ctx,{type:'bar',data:{labels:data.map(x=>x.b),datasets:[{data:data.map(x=>x.ones),backgroundColor:pal}]},options:{indexAxis:'y',plugins:{legend:{display:false},datalabels:{anchor:'end',align:'right',formatter:v=>v+' #1s'}},responsive:true,maintainAspectRatio:false},plugins:[ChartDataLabels]});
  }

  function renderDonut(data){
    const ctx=document.getElementById('donutChart').getContext('2d');
    donutChart&&donutChart.destroy();
    const pal=['#4f46e5','#10b981','#f59e0b','#ef4444','#3b82f6'];
    donutChart=new Chart(ctx,{type:'doughnut',data:{labels:data.map(x=>x.b),datasets:[{data:data.map(x=>x.ones),backgroundColor:pal}]},options:{plugins:{legend:{position:'bottom'},datalabels:{formatter:v=>v}},responsive:true,maintainAspectRatio:false},plugins:[ChartDataLabels]});
  }

  function renderTable(data){
    const th='<th>‡§∞‡§Å‡§ï</th><th>#1s</th>'+schemes.map(h=>`<th>${h}</th>`).join('');
    document.getElementById('tblHead').innerHTML=th;
    const rows=data.map((r,i)=>`<tr class="${i<3?'top5':''}${i>=data.length-3?' bot5':''}">
      <td>${r.rank}</td><td>${r.ones}</td>${schemes.map(s=>`<td>${rawData.find(x=>x._block===r.b)[s]||''}</td>`).join('')}
    </tr>`).join('');
    document.getElementById('tblBody').innerHTML=rows;
  }

  function togglePage2(block){
    renderPage2(block);
    document.getElementById('page1').style.display='none';
    document.getElementById('page2').style.display='';
  }

  function renderPage2(block){
    const all=getRankOnes();
    const top5=all.slice(0,5),mid5=all.slice(5,10),bot5=all.slice(-5);
    const kpiMap={'top':top5,'mid':mid5,'bot':bot5};
    document.querySelectorAll('.nav-switcher .nav-link').forEach(el=>{
      el.onclick=()=>{
        document.querySelectorAll('.nav-switcher .nav-link').forEach(x=>x.classList.remove('active'));
        el.classList.add('active');
        const type=el.dataset.type;
        document.getElementById('page2KPI').innerHTML = kpiMap[type].map(x=>`
          <div class="kpi-card ${type}" onclick="showTalukaAnalysis('${x.b}')">
            <i class="fas fa-chart-line kpi-icon"></i>
            <div>${x.b}</div><div>${x.ones} #1s</div>
          </div>`).join('');
      };
    });
    // activate first
    document.querySelector('.nav-switcher .nav-link.active').click();

    renderSchemeRankChart2(block);
    renderDetail(block);
  }

  function renderSchemeRankChart2(block){
    const tal=rawData.find(r=>r._block===block);
    const arr=schemes.map(s=>({s,rank:parseInt(tal[s])||999})).sort((a,b)=>a.rank-b.rank);
    const ctx=document.getElementById('schemeRankChart2').getContext('2d');
    schemeRankChart2&&schemeRankChart2.destroy();
    schemeRankChart2=new Chart(ctx,{
      type:'bar',data:{labels:arr.map(a=>a.s),datasets:[{data:arr.map(a=>a.rank),
        backgroundColor:arr.map(a=>a.rank===1?'#10b981':a.rank<=3?'#f59e0b':'#ef4444')}]},
      options:{plugins:{legend:{display:false},datalabels:{anchor:'end',align:'top',formatter:v=>`#${v}`,font:{size:8}}},responsive:true,maintainAspectRatio:false,scales:{y:{reverse:true}}},
      plugins:[ChartDataLabels]
    });
  }

  function renderDetail(block){
    const tal=rawData.find(r=>r._block===block);
    const arr=schemes.map(s=>({s,rank:parseInt(tal[s])||999})).sort((a,b)=>a.rank-b.rank);
    const exc=arr.slice(0,3),need=arr.slice(3,Math.ceil(arr.length*0.7)),att=arr.slice(Math.ceil(arr.length*0.7));
    document.getElementById('detailSection').innerHTML=
      `<div class="glass progress-section progress-excellent">üèÜ ‡§™‡•ç‡§∞‡§ó‡§§‡•Ä ‡§Ö‡§∏‡§≤‡•á‡§≤‡•á:${exc.map(a=>a.s).join(', ')}</div>
       <div class="glass progress-section progress-needs">‚öñÔ∏è ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï:${need.map(a=>a.s).join(', ')}</div>
       <div class="glass progress-section progress-attention">üö® ‡§µ‡§ø‡§∂‡•á‡§∑:${att.map(a=>a.s).join(', ')}</div>`;
  }

  function downloadCSV(){
    const d=getRankOnes();
    let csv='‡§∞‡§Å‡§ï,#1s,'+schemes.join(',')+'\n'+d.map(r=>`${r.rank},${r.ones},`+schemes.map(s=>rawData.find(x=>x._block===r.b)[s]||'').join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv'}),u=URL.createObjectURL(blob),a=document.createElement('a');a.href=u;a.download='taluka-data.csv';a.click();URL.revokeObjectURL(u);
  }

  (async()=>{try{const v=await fetchSheet();parse(v);renderControls();showAll();}catch(e){alert('Error:'+e)}})();
</script>
</body>
</html>
