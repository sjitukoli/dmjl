<!DOCTYPE html>
<html lang="mr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§∞‡§Å‡§ï‡§ø‡§Ç‡§ó ‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§°</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body { font-family:'Noto Sans Devanagari',sans-serif; background:#f8f9fa;}
    .header-gradient { background: linear-gradient(135deg,#667eea,#764ba2);}
    .kpi-glow {
      border-radius:14px; position:relative; overflow:hidden;
      background: #fff; box-shadow:0 4px 18px 2px rgba(110,77,181,0.09);
    }
    .kpi-glow:before {
      content:""; position:absolute; z-index:0; top:-4px; left:-4px; right:-4px; bottom:-4px;
      border-radius:19px; padding:0;
      background:conic-gradient(from var(--glow-angle,0deg), #ff38c6 10%, #ffd539 35%, #5be384 66%, #47bded 85%, #ff38c6 100%);
      animation: kpi-spin 4s linear infinite;
      filter: blur(1.1px);
    }
    @keyframes kpi-spin { 100% { --glow-angle: 360deg; } }
    .kpi-glow .card-body { position:relative; z-index:1; background:transparent; }
    .kpi-glow-block { 
      border-radius:14px; padding:14px 16px 12px 16px;
      min-height: 110px;
      box-shadow: 0 2px 24px 0 rgba(76,64,143,0.07);
      font-size:1.09em;
      display:flex; align-items:center; gap:10px;
    }
    .kpi-green   { background: rgba(40,167,69,0.11);}
    .kpi-red     { background:rgba(220,53,69,0.12);}
    .kpi-blue    { background:rgba(52,144,220,0.11);}
    .kpi-icon-kpi{ font-size:2.3rem; margin-right:.8rem;}
    .kpi-glow .card-body>div>h5 {margin-bottom:.45rem;}
    /* Table/charts */
    .chart-container{ position:relative; height:305px; }
    .table-row-top5{ border-left:5px solid #28a745; background:rgba(40,167,69,0.14);}
    .table-row-bottom5{ border-left:5px solid #dc3545; background:rgba(220,53,69,0.1);}
    .table-row-middle{ border-left:5px solid #ffc107; background:rgba(251,193,7,0.07);}
    .small-space{ max-width:162px; min-width:106px; }
    /* ===== Summary Table Styling ===== */
    .sum-table th, .sum-table td { vertical-align:middle; position:relative; border-radius:9px; font-size: 1rem;}
    .sum-table thead th { padding:12px 7px; font-size:1.14rem; letter-spacing:.03em; background: linear-gradient(90deg,#e2e4fb,#d9f5f4);}
    .sum-cell { text-align:center; font-weight:500; box-shadow:0 1px 6px 0 rgba(110,77,181,0.06);}
    .sum-taluka { font-weight:600; background:linear-gradient(87deg,#e5e7ff,#f0fcfc);}
    .sum-top { background:linear-gradient(90deg,#F8FFFE,#d0ffea 90%);}
    .sum-bottom { background:linear-gradient(90deg,#fbecec,#fff6f6);}
    .sum-mid { background:linear-gradient(90deg,#fefaef, #f3f9ea);}
    .sum-cell { transition: box-shadow .25s; border-radius:7px;}
    .sum-table tbody tr:hover>.sum-cell { box-shadow:0 0 14px #aecbff75;}
    .sum-table-striped tbody tr:nth-child(even) > .sum-cell { background: rgba(187,220,255,0.09);}
    .sum-table tfoot td { background:#e6f3fc;}
    .sum-table .sum-cell { min-width:2.6em;}
    .summary-label { font-size:0.95em; font-style:italic; color:#888;}
    .multi-info { font-size: 0.89em; color:#444; margin-top: 2px;}
  </style>
</head>
<body>
  <div id="loadingOverlay" class="loading-overlay" style="display:none;">
    <div class="loading-spinner"></div>
  </div>
  <header class="header-gradient py-4 mb-3 text-white">
    <div class="container d-flex justify-content-between align-items-center">
      <h1 class="mb-0"><i class="fas fa-chart-line me-2"></i>‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§∞‡§Å‡§ï‡§ø‡§Ç‡§ó</h1>
      <button id="refreshBtn" class="btn btn-light btn-lg"><i class="fas fa-sync-alt me-2"></i>‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡§æ</button>
    </div>
  </header>
  <div class="container">
    <!-- KPI -->
    <div class="row mb-3" id="kpiCards"></div>
    <!-- Charts -->
    <div class="row mb-3">
      <div class="col-md-6 mb-4"><div class="card">
        <div class="card-header bg-success text-white"><span><i class="fas fa-trophy me-2"></i>‡§∏‡§∞‡•ç‡§µ‡•ã‡§§‡•ç‡§ï‡•É‡§∑‡•ç‡§ü ‡•´ ‡§§‡§æ‡§≤‡•Å‡§ï‡•á</span></div>
        <div class="card-body"><div class="chart-container"><canvas id="topChart"></canvas></div></div>
      </div></div>
      <div class="col-md-6 mb-4"><div class="card">
        <div class="card-header bg-danger text-white"><span><i class="fas fa-times-circle me-2"></i>‡§ï‡§Æ‡§ï‡•Å‡§µ‡§§ ‡•´ ‡§§‡§æ‡§≤‡•Å‡§ï‡•á</span></div>
        <div class="card-body"><div class="chart-container"><canvas id="bottomChart"></canvas></div></div>
      </div></div>
    </div>
    <!-- Controls -->
    <div class="row mb-2 align-items-end">
      <div class="col-md-4">
        <label class="form-label h6 mb-1"><i class="fas fa-filter me-2"></i>‡§Ø‡•ã‡§ú‡§®‡§æ ‡§®‡§ø‡§µ‡§°‡§æ:</label>
        <select id="schemeSelect" class="form-select small-space"></select>
      </div>
      <div class="col-md-4">
        <label class="form-label h6 mb-1"><i class="fas fa-map-marker-alt me-2"></i>‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§®‡§ø‡§µ‡§°‡§æ:</label>
        <select id="talukaSelect" class="form-select small-space" multiple size="6"></select>
        <div class="multi-info">
          <i class="fa fa-info-circle me-1"></i>
          <span>‡§è‡§ï‡§æ‡§™‡•á‡§ï‡•ç‡§∑‡§æ ‡§Ö‡§ß‡§ø‡§ï ‡§§‡§æ‡§≤‡•Å‡§ï‡•á/‡§Ø‡•ã‡§ú‡§®‡§æ ‡§®‡§ø‡§µ‡§°‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä <b>Ctrl</b> (Windows) ‡§ï‡§ø‡§Ç‡§µ‡§æ <b>Cmd</b> (Mac) ‡§µ‡§æ‡§™‡§∞‡§æ.</span>
        </div>
      </div>
      <div class="col-md-4">
        <div class="d-flex justify-content-center align-items-center gap-2">
          <button id="submitBtn" class="btn btn-primary">Submit</button>
          <button id="resetBtn" class="btn btn-outline-secondary">Reset</button>
          <button id="summaryBtn" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#summaryModal">
            <i class="fas fa-list me-2"></i>Summary
          </button>
        </div>
      </div>
    </div>
    <!-- Table -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white"><h5 class="mb-0"><i class="fas fa-table me-2"></i>‡§§‡§æ‡§≤‡•Å‡§ï‡§æ ‡§∞‡§Å‡§ï‡§ø‡§Ç‡§ó ‡§ü‡•á‡§¨‡§≤</h5></div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table id="rankingTable" class="table table-hover mb-0">
            <thead>
              <tr>
                <th class="small-space">‡§§‡§æ‡§≤‡•Å‡§ï‡§æ</th>
                <th>‡§ü‡•â‡§™ ‡§Ø‡•ã‡§ú‡§®‡§æ‡§Ç‡§ö‡•Ä ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <!-- SUMMARY MODAL -->
  <div class="modal fade" id="summaryModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">‡§°‡•á‡§ü‡§æ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <span class="summary-label">‡§∞‡§Ç‡§ó : <span style="color:#28a745;">1 (‡§ó‡§°‡§¶ ‡§∞‡§Ç‡§ó - ‡§ü‡•â‡§™)</span>, <span style="color:#ffc107;">2-3/11-12 (‡§Æ‡§ß‡•ç‡§Ø‡§Æ)</span>, <span style="color:#dc3545;">13-15 (‡§ï‡§Æ‡§ï‡•Å‡§µ‡§§)</span></span>
          <div class="table-responsive">
            <table id="summaryTable" class="table sum-table table-bordered table-striped text-center mb-1 sum-table-striped">
              <thead><tr id="summaryHeader" class="sum-head"></tr></thead>
              <tbody id="summaryBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const SHEET_ID='1aINSij-6mXtt4Gbocn0A1PHbuh7XMImHL0zFmdVKhVs',
      API_KEY='AIzaSyBmci6WRXJCilTloJnQ1F6gc2qg1aJ96o0',
      VAL_RANGE='Rank!B5:AI20',
      API_URL=`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${VAL_RANGE}?key=${API_KEY}`,
      SUMMARY_URL=`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Rank!B6:AI20?key=${API_KEY}`;
let dashboard;
class Dashboard {
  constructor(){
    this.talukas=[]; this.schemes=[]; this.rankings=[]; this.processed=[];
    this.selectedScheme='all'; this.selectedTalukas=[];
    this.charts={};
    this._summaryLoaded = false;
    this._summaryRows = [];
    this._summarySchemes = [];
    this.init();
  }
  init(){
    document.getElementById('refreshBtn').onclick=()=>this.load();
    document.getElementById('submitBtn').onclick=()=>this.updateAll();
    document.getElementById('resetBtn').onclick=()=>window.location.reload();
    document.getElementById('summaryBtn').onclick=()=>this.showSummaryModal();
    this.load();
  }
  showLoading(){document.getElementById('loadingOverlay').style.display='flex';}
  hideLoading(){document.getElementById('loadingOverlay').style.display='none';}
  async load(){
    this.showLoading();
    try{
      const resp=await fetch(API_URL);
      const v=(await resp.json()).values;
      this.schemes=v[0].slice(1);
      this.talukas=v.slice(1).map(r=>r[0]).filter(Boolean);
      this.rankings=v.slice(1).map(r=>r.slice(1).map(x=>+x));
      this.fillSelectors();
    }catch{ alert('‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§Ö‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä'); }
    this.process();
    this.updateAll();
    this.hideLoading();
  }
  process(){
    this.processed=this.talukas.map((t,i)=>{
      const r=this.rankings[i];
      const topCount = r.filter(v=>v===1).length;
      return {t,topCount, ranks:r};
    });
  }
  fillSelectors(){
    const ss=document.getElementById('schemeSelect'), ts=document.getElementById('talukaSelect');
    ss.innerHTML='<option value="all">‡§∏‡§∞‡•ç‡§µ ‡§Ø‡•ã‡§ú‡§®‡§æ</option>' + this.schemes.map((s,j)=>`<option value="${j}">${s}</option>`).join('');
    ts.innerHTML='';
    this.talukas.forEach(t=>{
      if(t.trim()) { const o=document.createElement('option'); o.value=t; o.text=t; ts.add(o);}
    });
    ss.value='all';
  }
  updateAll(){
    const sch=document.getElementById('schemeSelect').value,
          sel=document.getElementById('talukaSelect');
    let tarr=Array.from(sel.selectedOptions).map(o=>o.value);
    this.selectedScheme=sch; this.selectedTalukas=tarr;
    // Process ordering: top1 count DESC
    let arr=(tarr.length?this.processed.filter(x=>tarr.includes(x.t)):this.processed)
      .map(x=>(sch==='all'?x:{t:x.t,topCount:(x.ranks[+sch]===1?1:0), ranks:x.ranks}))
      .sort((a,b)=>b.topCount-a.topCount||a.t.localeCompare(b.t,'mr'));
    this.showKPIs();
    this.showTable(arr);
    this.showCharts(arr);
  }
  showKPIs(){
    // KPIs always fixed for all data (not filtered)
    let base = this.processed.slice().sort((a,b)=>b.topCount-a.topCount||a.t.localeCompare(b.t,'mr'));
    let best=base[0],worst=base[base.length-1],avg=Math.round(base.reduce((s,x)=>s+x.topCount,0)/base.length);
    document.getElementById('kpiCards').innerHTML=`
      <div class="col-md-4 mb-3">
        <div class="card kpi-card kpi-glow kpi-green h-100 text-dark">
         <div class="card-body"><div class="kpi-glow-block"><i class="fas fa-star kpi-icon-kpi text-success"></i>
           <div><h5>‡§∏‡§∞‡•ç‡§µ‡•ã‡§§‡•ç‡§§‡§Æ ‡§§‡§æ‡§≤‡•Å‡§ï‡§æ</h5>
             <div><b>${best.t} ‚≠êÔ∏è</b></div>
             <div>‡§ü‡•â‡§™ ‡§Ø‡•ã‡§ú‡§®‡§æ‡§Ç‡§ö‡•Ä ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ: <b>${best.topCount}</b></div>
           </div></div></div>
        </div>
      </div>
      <div class="col-md-4 mb-3">
        <div class="card kpi-card kpi-glow kpi-red h-100 text-dark">
         <div class="card-body"><div class="kpi-glow-block"><i class="fas fa-times-circle kpi-icon-kpi text-danger"></i>
           <div><h5>‡§∏‡•Å‡§ß‡§æ‡§∞‡§£‡§æ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï</h5>
             <div><b>${worst.t} ‚ùå</b></div>
             <div>‡§ü‡•â‡§™ ‡§Ø‡•ã‡§ú‡§®‡§æ‡§Ç‡§ö‡•Ä ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ: <b>${worst.topCount}</b></div>
           </div></div></div>
        </div>
      </div>
      <div class="col-md-4 mb-3">
        <div class="card kpi-card kpi-glow kpi-blue h-100 text-dark">
         <div class="card-body"><div class="kpi-glow-block"><i class="fas fa-chart-bar kpi-icon-kpi text-primary"></i>
           <div><h5>‡§ú‡§ø‡§≤‡•ç‡§π‡§æ ‡§∏‡§∞‡§æ‡§∏‡§∞‡•Ä</h5>
             <div>üìä <b>${avg}</b></div>
           </div></div></div>
        </div>
      </div>`;
  }
  showTable(arr){
    let tbody='';
    arr.forEach((x,i)=>{
      let rowc=i<5?'table-row-top5':i>=arr.length-5?'table-row-bottom5':'table-row-middle';
      tbody+=`<tr class="${rowc}">
        <td class="small-space">${x.t}</td>
        <td>${x.topCount}</td></tr>`;
    });
    document.querySelector('#rankingTable tbody').innerHTML=tbody;
  }
  showCharts(arr){
    let bars=arr.length?arr.slice().sort((a,b)=>b.topCount-a.topCount||a.t.localeCompare(b.t,'mr')):this.processed;
    let ctx=document.getElementById('topChart').getContext('2d');
    if(this.charts['topChart']) this.charts['topChart'].destroy();
    this.charts['topChart']=new Chart(ctx,{
      type:'bar',
      data:{labels: bars.slice(0,5).map(x=>x.t),datasets:[{data: bars.slice(0,5).map(x=>x.topCount), backgroundColor:'#28a745', borderRadius:5}]},
      options:{indexAxis:'y',responsive:true,plugins:{legend:{display:false}},scales:{x:{beginAtZero:true}}}
    });
    ctx=document.getElementById('bottomChart').getContext('2d');
    if(this.charts['bottomChart']) this.charts['bottomChart'].destroy();
    this.charts['bottomChart']=new Chart(ctx,{
      type:'bar',
      data:{labels: bars.slice(-5).reverse().map(x=>x.t),datasets:[{data: bars.slice(-5).reverse().map(x=>x.topCount), backgroundColor:'#dc3545', borderRadius:5}]},
      options:{indexAxis:'y',responsive:true,plugins:{legend:{display:false}},scales:{x:{beginAtZero:true}}}
    });
  }
  async showSummaryModal(){
    if(!this._summaryLoaded){
      let resp=await fetch(SUMMARY_URL), j=await resp.json(), v=j.values;
      this._summaryRows = v;
      let sch=dashboard.schemes;
      document.getElementById('summaryHeader').innerHTML=`<th>‡§§‡§æ‡§≤‡•Å‡§ï‡§æ</th>${sch.map(s=>`<th>${s}</th>`).join('')}`;
      this._summaryLoaded=true;
    }
    document.getElementById('summaryBody').innerHTML = this._summaryRows.map(row=>{
      let t=row[0], ranks=row.slice(1).map(v=>+v);
      let tr = `<th class="summary-taluka">${t}</th>`;
      tr += ranks.map((val,i)=>{
        let cls='';
        if(val===1) cls='sum-top';
        else if(val>=13) cls='sum-bottom';
        else if(val>=2 && val<=3 || val>=11 && val<=12) cls='sum-mid';
        return `<td class="sum-cell ${cls}">${val||''}</td>`
      }).join('');
      return `<tr>${tr}</tr>`;
    }).join('');
  }
}
document.addEventListener('DOMContentLoaded',()=>dashboard=new Dashboard());
</script>
</body>
</html>
