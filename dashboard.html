<!DOCTYPE html>
<html lang="mr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>तालुका योजना रँकिंग डॅशबोर्ड</title>

  <!-- Bootstrap 5 CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-9ndCyUa6mY5m3yYgXfJg3KaV5r3h+oQcQ1N4xRkn5iG6iw2IYd5PvEjgKkV9GqSk"
    crossorigin="anonymous"
  />

  <!-- Font Awesome -->
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    rel="stylesheet"
  />

  <!-- Google Font: Noto Sans Devanagari -->
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;700&display=swap"
    rel="stylesheet"
  />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    body {
      font-family: 'Noto Sans Devanagari', sans-serif;
      background-color: #f8f9fa;
    }
    .header-gradient {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .card {
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: transform .3s;
    }
    .card:hover {
      transform: translateY(-5px);
    }
    .kpi-icon {
      font-size: 3rem;
      opacity: 0.8;
    }
    .table-row-top5 {
      border-left: 5px solid #28a745;
      background: rgba(40,167,69,0.1);
    }
    .table-row-middle5 {
      border-left: 5px solid #ffc107;
      background: rgba(255,193,7,0.1);
    }
    .table-row-bottom5 {
      border-left: 5px solid #dc3545;
      background: rgba(220,53,69,0.1);
    }
    .loading-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255,255,255,0.9);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .chart-container {
      position: relative;
      height: 300px;
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="text-center">
      <div class="spinner-border text-primary" style="width:3rem;height:3rem;"></div>
      <p class="mt-3">डेटा लोड होत आहे...</p>
    </div>
  </div>

  <!-- Header -->
  <header class="header-gradient py-4 mb-4">
    <div class="container d-flex justify-content-between align-items-center text-white">
      <div>
        <h1><i class="fas fa-chart-line me-2"></i>तालुका योजना रँकिंग डॅशबोर्ड</h1>
        <small>जिल्हा जळगाव — योजना आधारीत मूल्यांकन</small>
      </div>
      <button id="refreshBtn" class="btn btn-light btn-lg">
        <i class="fas fa-sync-alt me-2"></i>डेटा रिफ्रेश करा
      </button>
    </div>
  </header>

  <div class="container">
    <!-- KPI Cards -->
    <div class="row mb-4" id="kpiCards"></div>

    <!-- Controls -->
    <div class="row mb-3 align-items-end">
      <div class="col-md-6">
        <label for="schemeSelect" class="form-label">योजना निवडा:</label>
        <select id="schemeSelect" class="form-select">
          <option value="all">सर्व योजना</option>
        </select>
      </div>
      <div class="col-md-6">
        <label for="compareSelect" class="form-label">तालुका तुलना करा:</label>
        <select id="compareSelect" class="form-select">
          <option value="none">कोणतीही नाही</option>
        </select>
      </div>
    </div>

    <!-- Ranking Table -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">तालुका रँकिंग टेबल</h5>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table id="rankingTable" class="table table-hover mb-0">
            <thead class="table-dark">
              <tr id="tableHeader">
                <th>तालुका</th>
                <th>सरासरी रँक</th>
                <th>सर्वोत्तम योजना रँक</th>
                <th>सर्वात कमी योजना रँक</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <div class="row mb-5">
      <div class="col-md-6 mb-3">
        <div class="card">
          <div class="card-header bg-success text-white"><h6 class="mb-0">टॉप 5 तालुका</h6></div>
          <div class="card-body chart-container"><canvas id="topChart"></canvas></div>
        </div>
      </div>
      <div class="col-md-6 mb-3">
        <div class="card">
          <div class="card-header bg-danger text-white"><h6 class="mb-0">बॉटम 5 तालुका</h6></div>
          <div class="card-body chart-container"><canvas id="bottomChart"></canvas></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS Bundle -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-8vetXl+Kj1R0nQZx+VJUPIl+N5OCGmRvY9aDf4+BLXd6R4ZRlD0z8Ec7oWWLM1Sv"
    crossorigin="anonymous"
  ></script>

  <script>
    // ==== CONFIGURATION ====
    // Your Google Sheets credentials — keep these secure!
    const SHEET_ID    = '1aINSij-6mXtt4Gbocn0A1PHbuh7XMImHL0zFmdVKhVs';
    const API_KEY     = 'AIzaSyBSGGIDfZbLKeIiiHfPfm9xCgm3cTVH7HM';
    const SHEET_GID   = '0';            // Change if your “Rank” tab uses a different GID
    const CSV_URL     = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SHEET_GID}&key=${API_KEY}`;

    // Data structures
    let rawTalukas = [], schemes = [], dataMatrix = [];
    let processed  = [], topChart, bottomChart;

    document.addEventListener('DOMContentLoaded', init);

    function init() {
      document.getElementById('refreshBtn').onclick   = loadData;
      document.getElementById('schemeSelect').onchange = renderAll;
      document.getElementById('compareSelect').onchange= renderAll;
      loadData();
    }

    async function loadData() {
      showLoading();
      try {
        const res  = await fetch(CSV_URL);
        if (!res.ok) throw new Error('Fetch failed');
        const txt  = await res.text();
        parseCSV(txt);
      } catch (e) {
        console.warn('Using fallback sample data:', e);
        useSampleData();
      }
      processData();
      renderAll();
      hideLoading();
    }

    function parseCSV(text) {
      const lines = text.trim().split('\n');
      schemes = lines[0].split(',').slice(1);
      rawTalukas = [];
      dataMatrix = [];
      for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].split(',');
        rawTalukas.push(cols[0]);
        dataMatrix.push(cols.slice(1).map(Number));
      }
    }

    function useSampleData() {
      rawTalukas = ['भुसावळ','जळगाव','धुळे','शिर्डी','अकलूज','कोपरगाव','राहुरी','श्रिगोंदा','नेवासा','पाथर्डी','करजत','जामखेड','घनसावंगी','पारनेर','श्रीरामपूर'];
      schemes    = ['मग्नरेगा','स्वच्छ भारत','आवास','आयुष्मान','जल जीवन','इंद्रधनुष','बेटी बचाओ','फसल बीमा','मुद्रा','उज्ज्वला','कौशल्य','आरोग्य','शिक्षण','मध्यान्ह','मातृत्व'];
      dataMatrix = rawTalukas.map(() => Array(schemes.length).fill().map(() => Math.ceil(Math.random()*15)));
    }

    function processData() {
      processed = rawTalukas.map((taluka, i) => {
        const ranks = dataMatrix[i];
        const avg   = +(ranks.reduce((s,n) => s+n, 0)/ranks.length).toFixed(1);
        const best  = Math.min(...ranks), worst = Math.max(...ranks);
        return {
          taluka,
          ranks,
          avg,
          best,
          worst,
          bestSch: schemes[ranks.indexOf(best)],
          worstSch: schemes[ranks.indexOf(worst)]
        };
      }).sort((a,b) => a.avg - b.avg);
      populateSelectors();
    }

    function populateSelectors() {
      const sSel = document.getElementById('schemeSelect'),
            cSel = document.getElementById('compareSelect');
      sSel.innerHTML = '<option value="all">सर्व योजना</option>';
      cSel.innerHTML = '<option value="none">कोणतीही नाही</option>';
      schemes.forEach((s, i) => {
        sSel.add(new Option(s, i));
        cSel.add(new Option(s, i));
      });
    }

    function renderAll() {
      updateKPIs();
      updateTable();
      updateCharts();
    }

    function updateKPIs() {
      const best   = processed[0],
            worst  = processed.at(-1),
            avgDist= +(processed.reduce((s,p)=>s+p.avg,0)/processed.length).toFixed(1);
      document.getElementById('kpiCards').innerHTML = `
        <div class="col-md-4 mb-3">
          <div class="card bg-success text-white h-100">
            <div class="card-body d-flex align-items-center">
              <i class="fas fa-trophy kpi-icon me-3"></i>
              <div>
                <h5>सर्वोत्तम तालुका</h5>
                <h2>${best.taluka}</h2>
                <small>रँक: ${best.avg}</small>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div class="card bg-danger text-white h-100">
            <div class="card-body d-flex align-items-center">
              <i class="fas fa-exclamation-triangle kpi-icon me-3"></i>
              <div>
                <h5>कमकुवत तालुका</h5>
                <h2>${worst.taluka}</h2>
                <small>रँक: ${worst.avg}</small>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div class="card bg-primary text-white h-100">
            <div class="card-body d-flex align-items-center">
              <i class="fas fa-chart-bar kpi-icon me-3"></i>
              <div>
                <h5>जिल्हा सरासरी</h5>
                <h2>${avgDist}</h2>
                <small>(${processed.length} तालुका)</small>
              </div>
            </div>
          </div>
        </div>`;
    }

    function updateTable() {
      const f = document.getElementById('schemeSelect').value;
      const th = document.getElementById('tableHeader');
      const body = document.querySelector('#rankingTable tbody');
      if (f === 'all') {
        th.innerHTML = `<th>तालुका</th><th>सरासरी रँक</th>
                        <th>सर्वोत्तम योजना रँक</th><th>सर्वात कमी योजना रँक</th>`;
        body.innerHTML = processed.map((p,i) => `
          <tr class="${i<5?'table-row-top5':i>=processed.length-5?'table-row-bottom5':'table-row-middle5'}">
            <td>${p.taluka}</td>
            <td>${p.avg}</td>
            <td>${p.best} (${p.bestSch})</td>
            <td>${p.worst} (${p.worstSch})</td>
          </tr>`).join('');
      } else {
        const idx = +f;
        th.innerHTML = `<th>तालुका</th><th>${schemes[idx]} रँक</th>`;
        const arr = processed.map(p => ({ t: p.taluka, v: p.ranks[idx] }))
                             .sort((a,b)=>a.v-b.v);
        body.innerHTML = arr.map((x,i) => `
          <tr class="${i<5?'table-row-top5':i>=arr.length-5?'table-row-bottom5':'table-row-middle5'}">
            <td>${x.t}</td><td>${x.v}</td>
          </tr>`).join('');
      }
    }

    function updateCharts() {
      const f = document.getElementById('schemeSelect').value;
      let arr = processed.map(p => ({ t: p.taluka, v: p.avg }));
      let label = 'सरासरी रँक';
      if (f !== 'all') {
        const idx = +f;
        arr = processed.map(p => ({ t: p.taluka, v: p.ranks[idx] }));
        label = schemes[idx] + ' रँक';
      }
      arr.sort((a,b)=>a.v-b.v);
      const top5 = arr.slice(0,5), bot5 = arr.slice(-5).reverse();
      drawChart('topChart', top5, label, '#28a745');
      drawChart('bottomChart', bot5, label, '#dc3545');
    }

    function drawChart(id, data, label, color) {
      const ctx = document.getElementById(id).getContext('2d');
      if (window[id]) window[id].destroy();
      window[id] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map(d=>d.t),
          datasets: [{ label, data: data.map(d=>d.v), backgroundColor: color }]
        },
        options: {
          indexAxis:'y',
          responsive:true,
          scales:{ x:{ beginAtZero:true, reverse:true } }
        }
      });
    }

    function showLoading() { document.getElementById('loadingOverlay').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loadingOverlay').style.display = 'none'; }
  </script>
</body>
</html>
